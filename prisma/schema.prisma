generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Posts {
  id          Int         @id @default(autoincrement())
  title       String
  content     String 
  mediaUrl    String[]
  likes       Int @default(0)
  dislikes    Int @default(0)
  authorId    Int
  communityId Int
  comments    Comments[]
  author      Users       @relation(fields: [authorId], references: [id])
  community   Communities @relation(fields: [communityId], references: [id])
  postReaction  PostReaction[]
  favoritedPosts  FavoritedPosts[]
}

model Comments {
  id       Int    @id @default(autoincrement())
  content  String
  likes    Int @default(0)
  parentId Int?
  postId   Int
  authorId Int
  author   Users  @relation(fields: [authorId], references: [id])
  post     Posts  @relation(fields: [postId], references: [id])
  parent   Comments? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  Comments[] @relation("CommentReplies")
  commentLikes  CommentReaction[]
}

model Communities {
  id                  Int                   @id @default(autoincrement())
  name                String
  description         String
  public              Boolean @default(true)
  followers           Int @default(0)
  followedCommunities FollowedCommunities[]
  posts               Posts[]
  creatorId           Int
  creator             Users @relation(fields: [creatorId], references: [id])
}

model Messages {
  id             Int           @id @default(autoincrement())
  message        String
  timestamp      DateTime      @default(now())
  senderId       Int
  conversationId Int
  conversation   Conversations @relation(fields: [conversationId], references: [id])
  sender         Users         @relation(fields: [senderId], references: [id])
}

model Conversations {
  id           Int        @id @default(autoincrement())
  timestamp    DateTime   @default(now())
  messages     Messages[]
  conversations ConversationParticipant[]    
}

model ConversationParticipant {
  id             Int          @id @default(autoincrement())
  conversationId Int
  userId         Int
  conversation   Conversations @relation(fields: [conversationId], references: [id])
  user           Users         @relation(fields: [userId], references: [id])
  @@unique([conversationId, userId])
}


model Users {
  id                  Int                   @id @default(autoincrement())
  username            String                @unique
  passwordHash        String
  admin               Boolean               @default(false)
  email               String                @unique
  birthdate           DateTime
  followingCount      Int                   @default(0)
  communityCreator    Communities[]
  comments            Comments[]
  followedCommunities FollowedCommunities[]
  messages            Messages[]
  posts               Posts[]
  conversations       ConversationParticipant[]       
  postReaction        PostReaction[]
  favoritedPosts      FavoritedPosts[]
  commentLikes        CommentReaction[]
}

model FollowedCommunities {
  userId      Int
  communityId Int
  followedAt  DateTime    @default(now())
  community   Communities @relation(fields: [communityId], references: [id])
  user        Users       @relation(fields: [userId], references: [id])

  @@id([userId, communityId])
}

enum ReactionType {
  LIKE
  DISLIKE
}

model PostReaction {
  userId      Int
  postId      Int
  type        ReactionType
  user        Users     @relation(fields: [userId], references: [id])      
  post        Posts     @relation(fields: [postId], references: [id])
  likedAt     DateTime    @default(now())

  @@id([userId, postId])
}

model CommentReaction {
  userId      Int
  commentId   Int
  type        ReactionType
  user        Users   @relation(fields: [userId], references: [id])
  comment     Comments @relation(fields: [commentId], references: [id])
  likedAt     DateTime @default(now())
  
  @@id([userId, commentId])
}

model FavoritedPosts {
  userId      Int
  postId      Int
  user        Users     @relation(fields: [userId], references: [id])      
  post        Posts     @relation(fields: [postId], references: [id])
  favoritedAt DateTime    @default(now())

  @@id([userId, postId])
}

model Session {
  id        String   @id @default(uuid())
  sid       String   @unique
  data      String
  expiresAt DateTime
}
